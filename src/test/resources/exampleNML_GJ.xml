<Lems>
  
    <Target component="sim1" />


    <Include file="Cells.xml" />
    <Include file="Networks.xml" />
    <Include file="Simulation.xml" />
    

    <iafCell id="iafSpont" leakConductance="0.2nS" leakReversal="-54mV" thresh="-55mV" reset="-70mV" C="3.2pF"/>
    <iafCell id="iaf" leakConductance="0.2nS" leakReversal="-70mV" thresh="-55mV" reset="-70mV" C="3.2pF"/>
    
    <pulseGenerator id="pulseGen1" delay="50ms" duration="200ms" amplitude="0.0032nA" />
    


    <ComponentType name="gapJunction">
        <Parameter name="g" dimension="conductance" exposure="g"/>
        <Requirement name="v" dimension="voltage"/>

        <Exposure name="i" dimension="current"/>

        <InstanceRequirement name="peer" type="gapJunction"/>

        <Dynamics>
            <DerivedVariable name="vpeer" dimension="voltage" select="peer/v"/>
            <DerivedVariable name="i" exposure="i"  value="g * (vpeer - v)"/>
        </Dynamics>
    </ComponentType>
    
    
    <gapJunction id="gj1" g="10pS"/>
    

    <ComponentType name="Network">
        <Children name="populations" type="Population"/>
        <!--<Children name="connectivities" type="EventConnectivity"/>
        <Children name="excon" type="ExplicitConnectivity"/>-->
        <Children name="eleccon" type="electricalConnections"/>
    </ComponentType>


    <ComponentType name="Population">
        <ComponentReference name="component" type="Component" required="false"/>
        <Parameter name="size" dimension="none"/>
        <Structure>
            <MultiInstantiate number="size" component="component"/>
        </Structure>
    </ComponentType>


    <ComponentType name="gapJunctionConnection">
        <IndexParameter name="sourceIndex"/>
        <IndexParameter name="targetIndex"/>

        <ComponentRequirement name="sourceList"/>
        <ComponentRequirement name="targetList"/>

        <ComponentReference name="connector" type="gapJunction"/>

        <Structure>
            <With list="sourceList" index="sourceIndex" as="a"/>
            <With list="targetList" index="targetIndex" as="b"/>
            <Tunnel name="peer" endA="a" endB="b" componentA="connector" componentB="connector"/>
        </Structure>

    </ComponentType>



    <ComponentType name="electricalConnections">
        <ComponentReference name="sourceList" type="Population" local="true"/>
        <ComponentReference name="targetList" type="Population" local="true"/>
        <Children name="connections" type="gapJunctionConnection"/>
    </ComponentType>
    
    
    <Network id="net1">
        <Population id="iafPop1" component="iafSpont" size="2" />
        <Population id="iafPop2" component="iaf" size="2" />

        <electricalConnections sourceList="iafPop1" targetList="iafPop2">
            <gapJunctionConnection sourceIndex="0" targetIndex="1" connector="gj1"/>
        </electricalConnections>
        
        <!--<explicitInput target="iafPop1[0]" input="pulseGen1" destination="synapses"/>-->
    </Network>
    
    
    <Simulation id="sim1" length="300ms" step="0.02ms" target="net1">

        <Display id="d0" title="GJ in LEMS" timeScale="1ms" xmin="0"  xmax="300" ymin="-75" ymax="-50">
            <Line id="iafCell1_0" quantity="iafPop1[0]/v" scale="1mV" color="#FF0000" timeScale="1ms" />
            <Line id="iafCell1_1" quantity="iafPop1[1]/v" scale="1mV" color="#FF00FF" timeScale="1ms" />
            <Line id="iafCell2_0" quantity="iafPop2[0]/v" scale="1mV" color="#FFFF00" timeScale="1ms" />
            <Line id="iafCell2_1" quantity="iafPop2[1]/v" scale="1mV" color="#FFFFFF" timeScale="1ms" />
        </Display>


    </Simulation>
    
</Lems>